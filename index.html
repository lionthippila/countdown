<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>นับถอยหลัง QR PromptPay</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    #countdown { font-size: 2em; color: #FF6600; }
    #qr { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>สแกน QR เพื่อชำระเงิน</h2>
  <img id="qr" src="" alt="QR Code" width="200" height="200" />
  <div id="countdown">กำลังโหลด...</div>

  <script>
    // ดึงพารามิเตอร์จาก URL
    const urlParams = new URLSearchParams(window.location.search);
    const expiresStr = urlParams.get('expires');
    const qr = urlParams.get('qr');

    if (!expiresStr || !qr) {
      document.getElementById('countdown').innerText = "ข้อมูลไม่ครบถ้วน";
    } else {
      const expires = new Date(expiresStr);
      document.getElementById('qr').src = decodeURIComponent(qr);

      console.log('expires:', expires.toISOString());
      console.log('now (local):', new Date().toISOString());

      function updateCountdown() {
        // ใช้เวลาปัจจุบัน UTC โดยปรับ offset ของ timezone
        const nowLocal = new Date();
        const nowUtc = new Date(nowLocal.getTime() + nowLocal.getTimezoneOffset() * 60000);

        const diff = expires.getTime() - nowUtc.getTime();

        if (diff <= 0) {
          document.getElementById('countdown').innerText = "หมดเวลาแล้ว";
          return;
        }

        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);

        document.getElementById('countdown').innerText = `เหลือเวลาอีก ${minutes} นาที ${seconds} วินาที`;
        setTimeout(updateCountdown, 1000);
      }

      updateCountdown();
    }
  </script>
</body>
</html>
